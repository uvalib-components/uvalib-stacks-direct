<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-sheets/google-sheets.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <seed-element></seed-element>

@element seed-element
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/seed-element
-->
<polymer-element name="uvalib-stacks-direct" attributes="desttitle floor area direct callnumber">

  <template>

    <link rel="stylesheet" href="uvalib-stacks-direct.css" />
    
    <google-sheets key="1FTA9scrRR17pmeRZNPOXZAYhgeG-40FcJp6Ry5_O7Gw" gid="0" rows="{{rows}}" published on-google-sheet-data="{{sheetLoaded}}">
    </google-sheets>

  </template>
  <script src="../sprintf/dist/sprintf.min.js"></script>
  <script>

    Polymer('uvalib-stacks-direct', {
      /**
       * The `callnumber` attribute sets an callnumber to find directions for
       * 
       * @attribute callnumber
       * @type string
       */
      callnumber: '',

      desttitle:'foo',
      floor:'',
      area:'',
      direct:'',
      
      /**
       * `fancy` is a property that does something fancy.
       * 
       * @property fancy
       * @type bool
       * @default false
       */
      fancy: false,

      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
      },

      /**
       * The `sayHello` method will return a greeting.
       * 
       * @method sayHello
       * @param {String} greeting Pass in a specific greeting.
       * @return {String} Returns a string greeting.
       */
      sayHello: function(greeting) {
        var response = greeting || 'Hello World!';
        return 'seed-element says, ' + response;
      },

      /**
       * The `seed-element-lasers-success` event is fired whenever we
       * call fireLasers.
       * 
       * @event seed-element-lasers-success
       * @param {Object} detail
       *   @param {string} detail.sound An amazing sound.
       */

      /**
       * The `fireLasers` method will fire the lasers. At least
       * it will dispatch an event that claims lasers were fired :)
       * 
       * @method fireLasers
       */
      fireLasers: function() {
        this.fire('seed-element-lasers-success', { sound: 'Pew pew pew!' });
      },

      sheetLoaded: function(){
        this.fire('directions-loaded',{});
      },

      callnumberChanged: function() {
        this.normalCallnum = this.normalizeCallnumber(this.callnumber);
        this.desttitle = '';
        this.floor = '';
        this.area = '';
        this.direct = '';
        for (var i=0; i<this.rows.length; i++) {
          var row = this.rows[i];
          var start = row.gsx$start.$t;
          var end = row.gsx$end.$t;
          if (this.normalCallnum >= start && this.normalCallnum <= end) {
            this.desttitle = row.gsx$title.$t;
            this.floor = row.gsx$floor.$t;
            this.area = row.gsx$area.$t;
            this.direct = row.gsx$direct.$t;
          }
        }
      },

      normalizeCallnumber: function(lcc) {
        var parsed = this.parseCallnumber(lcc);
        var alpha = parsed[0],
            inte = parsed[1],
            frac = parsed[2],
            rmdr = parsed[3],
            norm = '';
        if (frac == '') {
          if (inte == '') {
            norm = sprintf("%-3s", alpha);
          } else {
            norm = sprintf("%-3s%4d %s", alpha, inte, rmdr);
          }
        } else {
          norm = sprintf("%-3s%4d.%d %s", alpha, inte, frac, rmdr);
        }
        norm = norm.replace(/ +$/, '');
        return norm;
      },

      parseCallnumber: function(lcc) {
        var alpha = "",
            inte = "",
            frac = "",
            rmdr = "";
        lcc = lcc.replace(/^([A-Z]{1,3}) */, function(match,p1){
                alpha = p1;
                return "";
              } );
        lcc = lcc.replace(/^(\d+)/, function(match,p1){
                inte = p1;
                return "";
              } );
        if (inte) {
          rmdr = lcc.replace(/^\.(\d+)/, function(match,p1){
                  frac = p1;
                  return "";
                } );
          rmdr = rmdr.replace(/^ *\.?(?=[A-Z])/, '.');
        }
        rmdr = rmdr.replace(/\.(?=A-Z])/, '');
//        rmdr = rmdr.replace(/(?<=\d)(?=[A-Z])/g, ' ')
        return [alpha, inte, frac, rmdr];
      }
    });

  </script>

</polymer-element>
